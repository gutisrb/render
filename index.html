<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SmartFlow • Virtuelno Opremanje</title>
  <style>
    * {box-sizing:border-box;margin:0;padding:0;}
    body {font-family:sans-serif;background:#f7f9fc;color:#333;}
    .container {max-width:800px;margin:40px auto;padding:0 20px;}
    h1 {text-align:center;color:#2c3e50;margin-bottom:20px;}
    .card {background:#fff;border-radius:8px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.1);}
    label {display:block;margin:15px 0 5px;font-weight:600;}
    select, button {width:100%;padding:10px;font-size:1rem;border:1px solid #ccc;border-radius:4px;}
    .upload-box {border:2px dashed #ccc;border-radius:4px;padding:30px;text-align:center;cursor:pointer;transition:.2s;}
    .upload-box.drag-over {background:#e7fcf7;border-color:#2ecc71;}
    .preview-grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px;margin:20px 0;}
    .preview-item {background:#fff;border:1px solid #ddd;border-radius:4px;overflow:hidden;padding:6px;}
    .preview-item img {width:100%;height:80px;object-fit:cover;border-radius:4px;}
    .preview-item select {margin-top:6px;width:100%;font-size:.9rem;}
    button:disabled {background:#ccc;cursor:not-allowed;}
    .status {margin:15px 0;padding:10px;border-radius:4px;display:none;}
    .status.error {background:#fde2e2;color:#721c24;border:1px solid #fabdbd;}
    .status.info {background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb;}
  </style>
</head>
<body>
  <div class="container">
    <h1>SmartFlow • Virtuelno Opremanje</h1>
    <div class="card">
      <label for="style-select">Stil nameštaja:</label>
      <select id="style-select">
        <option value="">— Izaberite stil —</option>
        <option value="DT-INT-008">Skandinavski</option>
        <option value="DT-INT-002">Moderan minimalistički</option>
        <option value="DT-INT-014">Luksuzna spavaća</option>
        <option value="DT-INT-017">Industrijski</option>
      </select>

      <label>Slike (max 10):</label>
      <div class="upload-box" id="drop-area">
        <p>Prevucite slike ovde ili kliknite</p>
        <input type="file" id="file-input" accept="image/*" multiple style="display:none">
      </div>

      <div class="preview-grid" id="preview-grid"></div>

      <button id="run-btn" disabled>Generiši opremanje</button>
      <div class="status info" id="status"></div>
    </div>
  </div>

  <script>
  (function(){
    const WEBHOOK = 'https://hook.eu2.make.com/rcqkkybflqhtdml32kcod6h7ovrctmm8';
    const MAX = 10;
    let files = []; // { file, dataURL, roomType }

    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const preview = document.getElementById('preview-grid');
    const runBtn = document.getElementById('run-btn');
    const styleSel = document.getElementById('style-select');
    const statusBox = document.getElementById('status');

    // Helpers
    function showStatus(txt, isError=false){
      statusBox.textContent = txt;
      statusBox.className = 'status ' + (isError?'error':'info');
      statusBox.style.display = 'block';
      if(!isError) setTimeout(()=> statusBox.style.display='none',3000);
    }

    function updateRunBtn(){
      const ready = styleSel.value && files.length>0 && files.every(f=>f.roomType);
      runBtn.disabled = !ready;
    }

    // Downscale to max 2048px, JPEG, 85% quality
    async function downscale(file) {
      const url = URL.createObjectURL(file);
      const img = await new Promise(r=>{const i=new Image(); i.onload=()=>r(i); i.src=url;});
      const maxDim = 2048;
      const scale = Math.min(1, maxDim/Math.max(img.width, img.height));
      const canvas = document.createElement('canvas');
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      return new Promise(r=> canvas.toBlob(
        blob => r(new File([blob], file.name.replace(/\.[^.]+$/, '.jpg'), { type:'image/jpeg' })),
        'image/jpeg', 0.85
      ));
    }

    // File handling
    async function handleFiles(list){
      for(let f of list){
        if(!f.type.startsWith('image/')) continue;
        if(files.length>=MAX){ showStatus(`Max ${MAX} slika`, true); break; }
        if(files.some(x=>x.file.name === f.name)) continue;

        // Resize and convert
        const resized = await downscale(f);
        const obj = { file: resized, dataURL: '', roomType: '' };
        files.push(obj);
        const reader = new FileReader();
        reader.onload = e => {
          obj.dataURL = e.target.result;
          renderPreview();
          updateRunBtn();
        };
        reader.readAsDataURL(resized);
      }
    }

    function renderPreview(){
      preview.innerHTML = '';
      files.forEach((o,i)=>{
        const dom = document.createElement('div');
        dom.className = 'preview-item';
        dom.innerHTML = `
          <img src="${o.dataURL}">
          <select data-idx="${i}">
            <option value="">— Tip prostorije —</option>
            <option value="ST-INT-003">Dnevna soba</option>
            <option value="ST-INT-001">Spavaća soba</option>
            <option value="ST-INT-005">Kuhinja</option>
            <option value="ST-INT-007">Kupatilo</option>
            <option value="ST-INT-009">Kancelarija</option>
            <option value="ST-INT-011">Trpezarija</option>
          </select>
        `;
        dom.querySelector('select').addEventListener('change', e => {
          files[i].roomType = e.target.value;
          updateRunBtn();
        });
        preview.append(dom);
      });
    }

    // Drag & drop & click
    ['dragenter','dragover'].forEach(ev=>{
      dropArea.addEventListener(ev,e=>{ e.preventDefault(); dropArea.classList.add('drag-over'); });
    });
    ['dragleave','drop'].forEach(ev=>{
      dropArea.addEventListener(ev,e=>{
        e.preventDefault(); dropArea.classList.remove('drag-over');
        if(ev==='drop') handleFiles(e.dataTransfer.files);
      });
    });
    dropArea.addEventListener('click', _=> fileInput.click());
    fileInput.addEventListener('change', e=> handleFiles(e.target.files));

    // Send to webhook
    runBtn.addEventListener('click', async ()=>{
      runBtn.disabled = true;
      showStatus('Obrada u toku…');
      const payload = {
        stylePrompt: styleSel.value,
        images: files.map(o=>({
          name: o.file.name,
          mime: o.file.type,
          data: o.dataURL.split(',')[1],
          roomType: o.roomType
        }))
      };
      try {
        const res = await fetch(WEBHOOK, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error(res.status+' '+res.statusText);
        showStatus('Uspešno poslato!');
      } catch(err){
        console.error(err);
        showStatus('Greška: '+err.message, true);
      } finally {
        runBtn.disabled = false;
      }
    });

    // Update on style change
    styleSel.addEventListener('change', updateRunBtn);
  })();
  </script>
</body>
</html>
